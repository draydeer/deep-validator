var __extends=this&&this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};var _=require("lodash");var validator=require("validator");var DeepValidator=function(){function DeepValidator(schema){var _this=this;this._arrayAllow=false;this._nextError=null;this._messageInvalid=false;this._messageMissingKey=false;this._sarray={"##":{strict:void 0,v:[]}};this._schema={"##":{strict:void 0,v:[]}};this._strict=false;this._translator=null;this._tryAll=false;this.errors={};this.passed=false;this.schema=null;this.schema=schema;_.each(schema,function(v,k){var last=_this._schema,elem=_this._schema;k.split(".").forEach(function(v){last=elem;elem=elem[k=v]||(elem[v]={"##":{s:void 0,v:[]}});if(k==="[]"){last["##"].v.push({args:[],isValidator:true,message:void 0,validator:"isArray"})}});(_.isArray(v)?v:[v]).forEach(function(v){_.isArray(v)||(v=[v]);if(v[0]instanceof DeepValidator){last[k]["##"].v.push({args:v.slice(1),isValidator:true,message:null,validator:v[0]})}else if(_.isString(v[0])){var pair=v[0].split(":");if(pair[0]==="custom"){last[k]["##"].custom=v[1]}else if(pair[0]==="default"){last[k]["##"].def=v[1]}else if(pair[0]==="isExists"){last[k]["##"].strict=pair[1]||false}else if(pair[0]==="showAs"){last[k]["##"].showAs=pair[1]||false}else if(DeepValidator[pair[0]]||validator[pair[0]]||_[pair[0]]){last[k]["##"].v.push({args:v.slice(1),isValidator:pair[0].substr(0,2)==="is"||v[0]in DeepValidator._isValidators,message:pair[1],validator:pair[0]})}else{throw new Error("Validator is not defined: "+pair[0])}}else{last[k]["##"].v.push({args:v.slice(1),isValidator:v[0].substr(0,2)==="is"||v[0]in DeepValidator._isValidators,message:null,validator:v[0]})}})});this._sarray["[]"]=this._schema;this._translator=DeepValidator._translate}DeepValidator._translate=function(message){return message};DeepValidator.prototype._validate=function(data,schema,tryAll,errors,strict,message,key,ref){if(schema===void 0){schema={}}if(tryAll===void 0){tryAll=false}if(errors===void 0){errors={}}if(strict===void 0){strict=false}if(message===void 0){message=""}var isObject=_.isObject(data);for(var i=0,l=schema["##"].v.length;i<l;i++){var entry=schema["##"].v[i];var isValidator=true;var result=true;if(entry.validator instanceof DeepValidator){result=entry.validator.validate(data,true);if(result!==true){_.each(entry.validator.getErrors(),function(v,k){errors[message?message+"."+k:k]=v});return false}}else{if(_.isFunction(entry.validator)){var validator_1=entry.validator;isValidator=true;result=entry.message=validator_1(data,key,ref);data=ref[key]}else{var validator_2=entry.validator;if(DeepValidator[validator_2]){isValidator=entry.isValidator;result=DeepValidator[validator_2](data,entry.args[0],entry.args[1],entry.args[2],entry.args[3],key,ref,schema)}}if(isValidator){if(result!==true){errors[message]=entry.message||false;return false}}else{if(key!==void 0){data=result;ref[key]=result}}}}if(_.isArray(data)){if(schema["[]"]){for(var i=0,l=data.length;i<l;i++){if(this._validate(data[i],schema["[]"],tryAll,errors,strict,message?message+"."+i:i.toString(),i.toString(),data)===false){return false}}}}else{for(var k in schema){var field=schema[k]["##"]&&schema[k]["##"].showAs||k;var mes=message?message+"."+field:field;if(k!=="##"&&k!=="[]"){if(isObject){if(k in data||schema[k]["##"].custom&&schema[k]["##"].custom(k,data,k in data)){if(this._validate(data[k],schema[k],tryAll,errors,strict,mes,k,data)||tryAll){continue}else{return false}}if(schema[k]["##"].def!==void 0){data[k]=typeof schema[k]["##"].def==="function"?schema[k]["##"].def(k,data,k in data):schema[k]["##"].def;continue}}if(strict||schema[k]["##"].strict!==void 0){errors[mes]=schema[k]["##"].strict||this._messageMissingKey;if(tryAll===false){return false}}}}}return true};DeepValidator.clean=function(value,a,b,c,d,key,ref,schema){return _.pick(value,Object.keys(schema))};DeepValidator.isContains=function(value,compare){var matches=0;if(DeepValidator.isObject(value)){for(var i=0,l=compare.length;i<l;i++){if(compare[i]in value===false){return false}}return true}if(_.isArray(value)){for(var i=0,l=compare.length;i<l;i++){if(value.indexOf(compare[i])===-1){return false}}return true}return false};DeepValidator.isNotContains=function(value,compare){var matches=0;if(DeepValidator.isObject(value)){for(var i=0,l=compare.length;i<l;i++){if(compare[i]in value){return false}}return true}if(_.isArray(value)){for(var i=0,l=compare.length;i<l;i++){if(value.indexOf(compare[i])!==-1){return false}}return true}return false};DeepValidator.isContainsOnly=function(value,compare){var matches=0;if(DeepValidator.isObject(value)){for(var i=0,l=compare.length;i<l;i++){if(compare[i]in value){matches++}}return compare.length===matches&&Object.keys(value).length===matches}if(_.isArray(value)){for(var i=0,l=compare.length;i<l;i++){if(value.indexOf(compare[i])!==-1){matches++}}return compare.length===matches&&value.length===matches}return false};DeepValidator.isGreater=function(value,compare){return _.isNumber(value)&&value>compare};DeepValidator.isGreaterOrEqual=function(value,compare){return _.isNumber(value)&&value>=compare};DeepValidator.isGreaterOrEqualToZero=function(value){return value===0||this.isGreater(value,0)};DeepValidator.isLength=function(value,min,max){var length;if(_.isArray(value)||_.isString(value)){length=value.length}else if(this.isObject(value)){length=Object.keys(value).length}else{return false}if(min!==void 0&&length<min){return false}if(max!==void 0&&length>max){return false}return true};DeepValidator.isLess=function(value,compare){return _.isNumber(value)&&value<compare};DeepValidator.isLessOrEqual=function(value,compare){return _.isNumber(value)&&value<=compare};DeepValidator.isLessOrEqualToZero=function(value){return value===0||this.isLess(value,0)};DeepValidator.isNotEmpty=function(value){return this.isEmpty(value)===false};DeepValidator.isNotEmptyArray=function(value){return _.isArray(value)&&this.isEmpty(value)===false};DeepValidator.isNotEmptyObject=function(value){return this.isObject(value)&&this.isEmpty(value)===false};DeepValidator.isNotVoid=function(value){return value!==void 0};DeepValidator.isNumberNegative=function(value){return this.isLess(value,0)};DeepValidator.isNumberPositive=function(value){return this.isGreater(value,0)};DeepValidator.isNumberOrNumeric=function(value){return _.isNumber(value)||_.isString(value)&&validator.isNumeric(value)};DeepValidator.isObject=function(value){return _.isObjectLike(value)&&value instanceof Array===false};DeepValidator.isRange=function(value,min,max){return _.isNumber(value)&&value>=min&&value<=max};DeepValidator.isVoid=function(value){return value===void 0};DeepValidator.filter=function(value,filter,objectAllow){return _.pickBy(value,filter instanceof RegExp?function(v){return _.isString(v)?validator.matches(v,filter):objectAllow!==false&&_.isObjectLike(v)}:filter)};DeepValidator.filterKeys=function(value,filter){return _.pickBy(value,filter instanceof RegExp?function(v,k){return validator.matches(k,filter)}:filter)};DeepValidator.filterMongoDocKeys=function(value){return this.filterKeys(value,/^([^\$].*){1,}$/)};DeepValidator.toNumber=function(value){return this.isNumberOrNumeric(value)?Number(value):_.isNumber(value)?value:NaN};DeepValidator.toNullIfEmpty=function(value){return this.isEmpty(value)?null:value};DeepValidator.toString=function(value){return value===void 0?"":String(value)};DeepValidator.prototype.getErrors=function(asArray){if(asArray===void 0){asArray=false}return asArray?_.toArray(this.errors):this.errors};DeepValidator.prototype.getNextError=function(){var _this=this;if(this._nextError===null){var k=Object.keys(this.errors),i=0;this._nextError=function(){if(i++<k.length){return{field:k[i-1],message:_this.errors[k[i-1]]}}return void 0}}return this._nextError()};DeepValidator.prototype.setMessageInvalid=function(value){this._messageInvalid=value;return this};DeepValidator.prototype.setMessageMissingKey=function(value){this._messageMissingKey=value;return this};DeepValidator.prototype.setTranslator=function(value){this._translator=value;return this};DeepValidator.prototype.arrayAllow=function(value){if(value===void 0){value=true}this._arrayAllow=value;return this};DeepValidator.prototype.strict=function(value){if(value===void 0){value=true}this._strict=value;return this};DeepValidator.prototype.tryAll=function(value){if(value===void 0){value=true}this._tryAll=value;return this};DeepValidator.prototype.validate=function(data,arrayAllow,errors,prefix){if(arrayAllow===void 0){arrayAllow=false}this._nextError=null;this.errors={};if(_.isArray(data)){if(this._arrayAllow===false&&arrayAllow===false){this.errors={"??":this._messageInvalid};return this.passed=false}this._validate(data,this._sarray,this._tryAll,errors||this.errors,this._strict,prefix||"")}else{if(_.isObject(data)===false){this.errors={"??":this._messageInvalid};return this.passed=false}this._validate(data,this._schema,this._tryAll,errors||this.errors,this._strict,prefix||"")}return this.passed=_.isEmpty(this.errors)};DeepValidator._isValidators={contains:true,equals:true,matches:true};DeepValidator._=_;DeepValidator.alpha=validator.alpha;DeepValidator.blacklist=validator.blacklist;DeepValidator.escape=validator.escape;DeepValidator.isAfter=validator.isAfter;DeepValidator.isAlpha=validator.isAlpha;DeepValidator.isAlphanumeric=validator.isAlphanumeric;DeepValidator.isArray=_.isArray;DeepValidator.isBase64=validator.isBase64;DeepValidator.isBefore=validator.isBefore;DeepValidator.isBoolean=validator.isBoolean;DeepValidator.isByteLength=validator.isByteLength;DeepValidator.isCreditCard=validator.isCreditCard;DeepValidator.isCurrency=validator.isCurrency;DeepValidator.isDataURI=validator.isDataURI;DeepValidator.isDate=validator.isDate;DeepValidator.isDateAfter=validator.isAfter;DeepValidator.isDateBefore=validator.isBefore;DeepValidator.isDecimal=validator.isDecimal;DeepValidator.isDivisibleBy=validator.isDivisibleBy;DeepValidator.isEmail=validator.isEmail;DeepValidator.isEmpty=_.isEmpty;DeepValidator.isEquals=_.isEqual;DeepValidator.isFQDN=validator.isFQDN;DeepValidator.isFloat=validator.isFloat;DeepValidator.isFullWidth=validator.isFullWidth;DeepValidator.isHalfWidth=validator.isHalfWidth;DeepValidator.isHexColor=validator.isHexColor;DeepValidator.isHexadecimal=validator.isHexadecimal;DeepValidator.isIP=validator.isIP;DeepValidator.isISBN=validator.isISBN;DeepValidator.isISIN=validator.isISIN;DeepValidator.isISO8601=validator.isISO8601;DeepValidator.isIn=validator.isIn;DeepValidator.isInt=validator.isInt;DeepValidator.isLowercase=validator.isLowercase;DeepValidator.isMACAddress=validator.isMACAddress;DeepValidator.isMatches=validator.matches;DeepValidator.isMD5=validator.isMD5;DeepValidator.isMobilePhone=validator.isMobilePhone;DeepValidator.isMongoId=validator.isMongoId;DeepValidator.isMultibyte=validator.isMultibyte;DeepValidator.isNull=validator.isNull;DeepValidator.isNumber=_.isNumber;DeepValidator.isNumeric=validator.isNumeric;DeepValidator.isPartialEqual=_.isMatch;DeepValidator.isString=_.isString;DeepValidator.isSubstring=validator.contains;DeepValidator.isSurrogatePair=validator.isSurrogatePair;DeepValidator.isURL=validator.isURL;DeepValidator.isUUID=validator.isUUID;DeepValidator.isUppercase=validator.isUppercase;DeepValidator.isVariableWidth=validator.isVariableWidth;DeepValidator.isWhitelisted=validator.isWhitelisted;DeepValidator.ltrim=validator.ltrim;DeepValidator.normalizeEmail=validator.normalizeEmail;DeepValidator.rtrim=validator.rtrim;DeepValidator.stripLow=validator.stripLow;DeepValidator.toBoolean=validator.toBoolean;DeepValidator.toDate=validator.toDate;DeepValidator.toFloat=validator.toFloat;DeepValidator.toInt=validator.toInt;DeepValidator.trim=validator.trim;DeepValidator.unescape=validator.unescape;DeepValidator.whitelist=validator.whitelist;return DeepValidator}();exports.DeepValidator=DeepValidator;_.each(DeepValidator,function(v,k){if(_.isFunction(v)&&k.substr(0,2)==="is"){DeepValidator[k+"OrNull"]=function(value){return value===null||DeepValidator[k].apply(DeepValidator,arguments)}}});var Validator=function(_super){__extends(Validator,_super);function Validator(){_super.apply(this,arguments)}return Validator}(DeepValidator);exports.Validator=Validator;exports.deepValidator=function(schema){return new DeepValidator(schema)};