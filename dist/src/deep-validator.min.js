"use strict";var __extends=this&&this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};var _=require("lodash");var validator=require("validator");var ValidatorEntry=function(){function ValidatorEntry(validator,message,args,notExtendErrors){this.args=args||[];this.isHandler=_.isFunction(validator);this.isNested=validator instanceof DeepValidator;this.isValidator=this.isHandler||validator instanceof DeepValidator||(_.isString(validator)?validator.substr(0,2)==="is"||validator in DeepValidator.isValidators:false);this.message=message!==void 0?message:null;this.notExtendErrors=notExtendErrors===true||validator instanceof DeepValidatorMerged;this.validator=validator}return ValidatorEntry}();exports.ValidatorEntry=ValidatorEntry;var ValidatorEntrySet=function(){function ValidatorEntrySet(){this.current=new ValidatorEntrySetCurrent;this.properties={}}return ValidatorEntrySet}();exports.ValidatorEntrySet=ValidatorEntrySet;var ValidatorEntrySetCurrent=function(){function ValidatorEntrySetCurrent(){this.v=[]}return ValidatorEntrySetCurrent}();exports.ValidatorEntrySetCurrent=ValidatorEntrySetCurrent;var FlowBuilder=function(){function FlowBuilder(){this.flow=[]}FlowBuilder.prototype.default=function(value){this.flow.push(["default",value]);return this};FlowBuilder.prototype.if=function(checker,trueFlow,falseFlow){this.flow.push(["if",checker,trueFlow,falseFlow]);return this};FlowBuilder.prototype.isExists=function(message){this.flow.push([message?"isExists:"+message:"isExists"]);return this};FlowBuilder.prototype.isInRange=function(min,max,message){this.flow.push([message?"isInRange:"+message:"isInRange",min,max]);return this};FlowBuilder.prototype.isNegative=function(message){this.flow.push([message?"isNegative:"+message:"isNegative"]);return this};FlowBuilder.prototype.isNumber=function(message){this.flow.push([message?"isNumber:"+message:"isNumber"]);return this};FlowBuilder.prototype.isNumberOrNumeric=function(message){this.flow.push([message?"isNumberOrNumeric:"+message:"isNumberOrNumeric"]);return this};FlowBuilder.prototype.isPositive=function(message){this.flow.push([message?"isPositive:"+message:"isPositive"]);return this};FlowBuilder.prototype.isString=function(message){this.flow.push([message?"isString:"+message:"isString"]);return this};FlowBuilder.prototype.required=function(message){this.flow.push([message?"required:"+message:"required"]);return this};FlowBuilder.prototype.showAs=function(name){this.flow.push(["showAs",name]);return this};return FlowBuilder}();exports.FlowBuilder=FlowBuilder;var Flow=function(){function Flow(){}Flow.default=function(value){return(new FlowBuilder).default(value)};Flow.if=function(checker,trueBranch,falseBranch){return(new FlowBuilder).if(checker,trueBranch,falseBranch)};Flow.isExists=function(message){return(new FlowBuilder).isExists(message)};Flow.isInRange=function(min,max,message){return(new FlowBuilder).isInRange(min,max,message)};Flow.isNegative=function(message){return(new FlowBuilder).isNegative(message)};Flow.isNumber=function(message){return(new FlowBuilder).isNumber(message)};Flow.isNumberOrNumeric=function(message){return(new FlowBuilder).isNumberOrNumeric(message)};Flow.isPositive=function(message){return(new FlowBuilder).isPositive(message)};Flow.isString=function(message){return(new FlowBuilder).isString(message)};Flow.required=function(message){return(new FlowBuilder).required(message)};Flow.showAs=function(name){return(new FlowBuilder).showAs(name)};return Flow}();exports.Flow=Flow;var validatorIfInvalidConditionCheckerError=new Error("Validator of [if] must define a valid condition checker.");var validatorIfInvalidError=new Error("Validator of [if] must contain a condition checker and sub-flows.");var validatorIfInvalidSubFlowError=new Error("Validator of [if] must define a valid sub-flows instances of [DeepValidator].");var DeepValidator=function(){function DeepValidator(schema,rootFlow){this.errors={};this.passed=false;this.schema=null;this._arrayAllow=false;this._included={};this._includedPending=[];this._maxDepth=99999999;this._maxDepthPassToNested=true;this._messageMaxDepth=false;this._messageInvalid=false;this._messageMissingKey=false;this._messageNotObject=false;this._name="included";this._nextError=null;this._schema=new ValidatorEntrySet;this._schemaAsArray=new ValidatorEntrySet;this._schemaCoverAll=false;this._strict=false;this._translator=null;this._tryAll=false;if(rootFlow){this._schemaCoverAll=true;schema=_.fromPairs(_.map(schema,function(v,k){return["$."+k,v]}));schema["$"]=rootFlow}this._compile(schema);this._translator=this._translate}DeepValidator.prototype._addError=function(errors,key,value,path){errors[path?path+"."+key:key]=this._translator(value);return this};DeepValidator.prototype._compile=function(schema){var _this=this;this._includedPending=[];this.schema=schema;_.each(schema,function(v,k){var elem=_this._schema;var last=_this._schema;k.split(".").forEach(function(v){last=elem;if(elem.properties[k=v]===void 0){elem=elem.properties[v]=new ValidatorEntrySet}else{elem=elem.properties[v]}if(k==="[]"){last.current.v.push(new ValidatorEntry("isArray"))}});if(v instanceof FlowBuilder){v=v.flow}var es=last.properties[k];(_.isArray(v)?v:[v]).forEach(function(v){_.isArray(v)||(v=[v]);if(v[0]instanceof DeepValidator||_.isFunction(v[0])){es.current.v.push(new ValidatorEntry(v[0]))}else if(_.isString(v[0])){var pair=v[0].split(":");if(pair[0]==="custom"){if(_.isFunction(v[1])){es.current.custom=v[1]}else{throw new Error("Validator of [custom] must be a function.")}}else if(pair[0]==="default"){es.current.def=v[1]}else if(pair[0]==="include"||pair[0]==="self"){if(pair[0]==="self"){v[1]=pair[0]}if(false===v[1]in _this._included&&v[1]!=="self"){_this._includedPending.push(v[1])}else{es.current.v.push(new ValidatorEntry(v[1]==="self"?_this:_this._included[v[1]],null,v.slice(2)))}}else if(pair[0]==="isExists"||pair[0]==="required"){es.current.strict=pair[1]||false}else if(pair[0]==="showAs"){es.current.showAs=pair[1]||false}else if(DeepValidator[pair[0]]){var notExtendErrors=false;if(pair[0]==="if"){if(v.length!==4){throw validatorIfInvalidError}var cond=_.isArray(v[1])?v[1][0]:v[1];if(_.isString(cond)===false&&_.isFunction(cond)===false){throw validatorIfInvalidConditionCheckerError}if(!(v[2]instanceof DeepValidator)){if(DeepValidator.isObject(v[2])){v[2]=new DeepValidator(v[2])}else{throw validatorIfInvalidSubFlowError}}if(!(v[3]instanceof DeepValidator)){if(DeepValidator.isObject(v[3])){v[3]=new DeepValidator(v[3])}else{throw validatorIfInvalidSubFlowError}}if(_.isFunction(cond)===false){if(cond in DeepValidator&&cond.substr(0,2)==="is"){}else{throw new Error("Condition checker is not defined or invalid: "+cond)}}else{es.current.v.push(new ValidatorEntry("ifCustom",null,v.slice(1),true));return}notExtendErrors=true}es.current.v.push(new ValidatorEntry(pair[0],pair[1],v.slice(1),notExtendErrors))}else{throw new Error("Validator is not defined: "+pair[0])}}else if(DeepValidator.isObject(v[0])){es.current.v.push(new ValidatorEntry(new DeepValidator(v[0])))}else{throw new Error("Invalid value: "+String(v[0]))}})});this._schemaAsArray.properties["[]"]=this._schema;return this};DeepValidator.prototype._translate=function(message){return message};DeepValidator.prototype._validate=function(data,schema,tryAll,errors,strict,path,root,depth,key,ref){var _this=this;if(tryAll===void 0){tryAll=false}if(errors===void 0){errors={}}if(strict===void 0){strict=false}if(path===void 0){path=""}if(root===void 0){root=""}if(depth===void 0){depth=0}if(this._maxDepth<depth){this._addError(errors,"*",this._messageMaxDepth,root);return false}var isObject=_.isObject(data);for(var i=0,l=schema.current.v.length;i<l;i++){var entry=schema.current.v[i];var entryValidator=entry.validator;var isValidator=true;var result=true;if(entry.isNested){var validator_1=entryValidator;var oldMaxDepth=validator_1.getMaxDepth();if(this._maxDepthPassToNested){validator_1.maxDepth(this._maxDepth)}var nestedErrors={};result=validator_1.validate(data,true,nestedErrors,void 0,this._maxDepthPassToNested?depth:0);if(this._maxDepthPassToNested){validator_1.maxDepth(oldMaxDepth)}if(result!==true){result=nestedErrors}}else{if(entry.isHandler){var validator_2=entry.validator;result=entry.message=validator_2(data,key,ref);data=ref[key]}else{var validator_3=entry.validator;isValidator=entry.isValidator;result=DeepValidator[validator_3](data,entry.args[0],entry.args[1],entry.args[2],errors,key,ref,schema,depth)}}if(isValidator){if(result!==true){if(DeepValidator.isObject(result)){if(entry.notExtendErrors){_.each(result,function(v,k){_this._addError(errors,k,v,root)})}else{_.each(result,function(v,k){_this._addError(errors,k,v,path)})}}else{this._addError(errors,path,entry.message||false)}return false}}else{if(key!==void 0){data=result;if(result!==void 0){ref[key]=result}}}}if(_.isArray(data)){if(schema.properties["[]"]){for(var i=0,l=data.length;i<l;i++){if(this._validate(data[i],schema.properties["[]"],tryAll,errors,strict,path?path+"."+i:i.toString(),path,depth+1,i.toString(),data)===false){return false}}}}else{for(var k in schema.properties){if(k!=="[]"){var entry=schema.properties[k].current;var field=entry&&entry.showAs||k;var pathField=path?path+"."+field:field;if(isObject){if(k in data){if(this._validate(data[k],schema.properties[k],tryAll,errors,strict,pathField,path,depth+1,k,data)||tryAll){continue}else{return false}}if(entry.custom&&entry.custom(k,data)){}if(entry.def!==void 0){data[k]=_.isFunction(entry.def)?entry.def(k,data,k in data):entry.def;continue}}if(strict||entry.strict!==void 0){this._addError(errors,pathField,entry.strict||this._messageMissingKey);if(tryAll===false){return false}}}}}return true};DeepValidator.clean=function(value,a,b,c,d,key,ref,schema){_.each(value,function(v,k){if(!(k in schema.properties)){delete value[k]}});return value};DeepValidator.if=function(value,filter,flowTrue,flowFalse,errors,key,ref,schema){if(_.isArray(filter)===false){filter=[filter]}var result;if(DeepValidator[filter[0]](value,filter[1],filter[2],filter[3])){result=flowTrue.validate(ref);if(result===false){return flowTrue.getErrors()}}else{result=flowFalse.validate(ref);if(result===false){return flowFalse.getErrors()}}return true};DeepValidator.ifCustom=function(value,filter,flowTrue,flowFalse,errors,key,ref,schema){if(_.isArray(filter)===false){filter=[filter]}var result;if(filter[0](value,key,ref)){result=flowTrue.validate(ref);if(result===false){return flowTrue.getErrors()}}else{result=flowFalse.validate(ref);if(result===false){return flowFalse.getErrors()}}return true};DeepValidator.isContains=function(value,compare){var matches=0;if(DeepValidator.isObject(value)){for(var i=0,l=compare.length;i<l;i++){if(compare[i]in value===false){return false}}return true}if(_.isArray(value)){for(var i=0,l=compare.length;i<l;i++){if(value.indexOf(compare[i])===-1){return false}}return true}return false};DeepValidator.isDefined=function(value){return value!==void 0};DeepValidator.isNotContains=function(value,compare){var matches=0;if(DeepValidator.isObject(value)){for(var i=0,l=compare.length;i<l;i++){if(compare[i]in value){return false}}return true}if(_.isArray(value)){for(var i=0,l=compare.length;i<l;i++){if(value.indexOf(compare[i])!==-1){return false}}return true}return false};DeepValidator.isContainsOnly=function(value,compare){var matches=0;if(DeepValidator.isObject(value)){for(var i=0,l=compare.length;i<l;i++){if(compare[i]in value){matches++}}return compare.length===matches&&Object.keys(value).length===matches}if(_.isArray(value)){for(var i=0,l=compare.length;i<l;i++){if(value.indexOf(compare[i])!==-1){matches++}}return compare.length===matches&&value.length===matches}return false};DeepValidator.isGreater=function(value,compare){return _.isNumber(value)&&value>compare};DeepValidator.isGreaterOrEquals=function(value,compare){return _.isNumber(value)&&value>=compare};DeepValidator.isGreaterOrEqualsToZero=function(value){return value===0||this.isGreater(value,0)};DeepValidator.isIntOrNumeric=function(value){return _.isInteger(value)||_.isString(value)&&validator.isInt(value)};DeepValidator.isInRange=function(value,min,max){return _.isNumber(value)&&value>=min&&value<=max};DeepValidator.isInsignificant=function(value){return _.isObject(value)?this.isLength(value,1)===false:!!value===false};DeepValidator.isLength=function(value,min,max){var length;if(_.isArray(value)||_.isString(value)){length=value.length}else if(this.isObject(value)){length=Object.keys(value).length}else{return false}if(min!==void 0&&length<min){return false}if(max!==void 0&&length>max){return false}return true};DeepValidator.isLess=function(value,compare){return _.isNumber(value)&&value<compare};DeepValidator.isLessOrEquals=function(value,compare){return _.isNumber(value)&&value<=compare};DeepValidator.isLessOrEqualsToZero=function(value){return value===0||this.isLess(value,0)};DeepValidator.isNegative=function(value){return this.isNumberNegative(value)};DeepValidator.isNotEmpty=function(value){return this.isEmpty(value)===false};DeepValidator.isNotEmptyArray=function(value){return _.isArray(value)&&this.isEmpty(value)===false};DeepValidator.isNotEmptyObject=function(value){return this.isObject(value)&&this.isEmpty(value)===false};DeepValidator.isNotVoid=function(value){return this.isDefined(value)};DeepValidator.isNumberNegative=function(value){return this.isLess(value,0)};DeepValidator.isNumberPositive=function(value){return this.isGreater(value,0)};DeepValidator.isNumberOrNumeric=function(value){return _.isNumber(value)||_.isString(value)&&validator.isFloat(value)};DeepValidator.isObject=function(value){return _.isObjectLike(value)&&value instanceof Array===false};DeepValidator.isPositive=function(value){return this.isNumberPositive(value)};DeepValidator.isSignificant=function(value){return this.isInsignificant(value)===false};DeepValidator.isVoid=function(value){return this.isUndefined(value)};DeepValidator.isUndefined=function(value){return value===void 0};DeepValidator.filter=function(value,filter,objectAllow){if(filter instanceof RegExp){_.each(value,function(v,k){if(!(_.isString(v)?validator.matches(v,filter):objectAllow!==false&&_.isObjectLike(v))){delete value[k]}})}else{_.each(value,function(v,k){if(!filter(v)){delete value[k]}})}return value};DeepValidator.filterKeys=function(value,filter){if(filter instanceof RegExp){_.each(value,function(v,k){if(!validator.matches(k,filter)){delete value[k]}})}else{_.each(value,function(v,k){if(!filter(k)){delete value[k]}})}return value};DeepValidator.filterMongoDocKeys=function(value){return this.filterKeys(value,/^([^\$].*){1,}$/)};DeepValidator.toMongoId=function(value){var ObjectID=require("mongodb").ObjectID;var method=this.toMongoId=function(value){return ObjectID(value)};return method(value)};DeepValidator.toInt=function(value){return this.isNumberOrNumeric(value)?_.toInteger(value):NaN};DeepValidator.toFloat=function(value){return this.toNumber(value)};DeepValidator.toNumber=function(value){return this.isNumberOrNumeric(value)?Number(value):NaN};DeepValidator.toNullIfEmpty=function(value){return this.isEmpty(value)?null:value};DeepValidator.toNullIfInsignificant=function(value){return this.isInsignificant(value)?null:value};DeepValidator.toString=function(value){return value===void 0||value===null?"":String(value)};DeepValidator.prototype.getErrors=function(asArray){if(asArray===void 0){asArray=false}return asArray?_.toArray(this.errors):this.errors};DeepValidator.prototype.getMaxDepth=function(){return this._maxDepth};DeepValidator.prototype.getName=function(){return this._name};DeepValidator.prototype.getNextError=function(){var _this=this;if(this._nextError===null){var k_1=Object.keys(this.errors),i_1=0;this._nextError=function(){if(i_1++<k_1.length){return{field:k_1[i_1-1],message:_this.errors[k_1[i_1-1]]}}return void 0}}return this._nextError()};DeepValidator.prototype.setMessageInvalid=function(value){this._messageInvalid=value;return this};DeepValidator.prototype.setMessageMaxDepthReached=function(value){this._messageMaxDepth=value;return this};DeepValidator.prototype.setMessageMissingKey=function(value){this._messageMissingKey=value;return this};DeepValidator.prototype.setMessageNotObject=function(value){this._messageNotObject=value;return this};DeepValidator.prototype.setName=function(value){this._name=value;return this};DeepValidator.prototype.setTranslator=function(value){this._translator=value;return this};DeepValidator.prototype.arrayAllow=function(value){if(value===void 0){value=true}this._arrayAllow=value;return this};DeepValidator.prototype.include=function(validator){this._included[validator.getName()]=validator;return this._compile(this.schema)};DeepValidator.prototype.maxDepth=function(value){this._maxDepth=value;return this};DeepValidator.prototype.maxDepthPassToNested=function(value){if(value===void 0){value=true}this._maxDepthPassToNested=value;return this};DeepValidator.prototype.strict=function(value){if(value===void 0){value=true}this._strict=value;return this};DeepValidator.prototype.tryAll=function(value){if(value===void 0){value=true}this._tryAll=value;return this};DeepValidator.prototype.validate=function(data,arrayAllow,errors,prefix,depth){if(arrayAllow===void 0){arrayAllow=false}if(this._includedPending.length){throw new Error("Included validator is still pending for definition: "+this._includedPending[0])}if(!errors){this._nextError=null;this.errors={}}if(_.isArray(data)){if(this._arrayAllow===false&&arrayAllow===false){this._addError(errors||this.errors,"??",this._messageInvalid);return this.passed=false}this._validate(this._schemaCoverAll?{$:data}:data,this._schemaAsArray,this._tryAll,errors||this.errors,this._strict,prefix||"",prefix||"",depth)}else{if(_.isObject(data)===false){this._addError(errors||this.errors,"??",this._messageInvalid);return this.passed=false}this._validate(this._schemaCoverAll?{$:data}:data,this._schema,this._tryAll,errors||this.errors,this._strict,prefix||"",prefix||"",depth)}return this.passed=_.isEmpty(errors||this.errors)};DeepValidator._=_;DeepValidator.isValidators={contains:true,equals:true,if:true,ifCustom:true,matches:true};DeepValidator.alpha=validator.alpha;DeepValidator.blacklist=validator.blacklist;DeepValidator.escape=validator.escape;DeepValidator.isAfter=validator.isAfter;DeepValidator.isAlpha=validator.isAlpha;DeepValidator.isAlphanumeric=validator.isAlphanumeric;DeepValidator.isArray=_.isArray;DeepValidator.isBase64=validator.isBase64;DeepValidator.isBefore=validator.isBefore;DeepValidator.isBoolean=validator.isBoolean;DeepValidator.isByteLength=validator.isByteLength;DeepValidator.isCreditCard=validator.isCreditCard;DeepValidator.isCurrency=validator.isCurrency;DeepValidator.isDataURI=validator.isDataURI;DeepValidator.isDate=validator.isDate;DeepValidator.isDateAfter=validator.isAfter;DeepValidator.isDateBefore=validator.isBefore;DeepValidator.isDecimal=validator.isDecimal;DeepValidator.isDivisibleBy=validator.isDivisibleBy;DeepValidator.isEmail=validator.isEmail;DeepValidator.isEmpty=_.isEmpty;DeepValidator.isEquals=_.isEqual;DeepValidator.isFQDN=validator.isFQDN;DeepValidator.isFinite=_.isFinite;DeepValidator.isFloat=validator.isFloat;DeepValidator.isFullWidth=validator.isFullWidth;DeepValidator.isHalfWidth=validator.isHalfWidth;DeepValidator.isHexColor=validator.isHexColor;DeepValidator.isHexadecimal=validator.isHexadecimal;DeepValidator.isIP=validator.isIP;DeepValidator.isISBN=validator.isISBN;DeepValidator.isISIN=validator.isISIN;DeepValidator.isISO8601=validator.isISO8601;DeepValidator.isIn=validator.isIn;DeepValidator.isInt=validator.isInt;DeepValidator.isLowercase=validator.isLowercase;DeepValidator.isMACAddress=validator.isMACAddress;DeepValidator.isMatches=validator.matches;DeepValidator.isMD5=validator.isMD5;DeepValidator.isMobilePhone=validator.isMobilePhone;DeepValidator.isMongoId=validator.isMongoId;DeepValidator.isMultibyte=validator.isMultibyte;DeepValidator.isNaN=_.isNaN;DeepValidator.isNil=_.isNil;DeepValidator.isNull=validator.isNull;DeepValidator.isNumber=_.isNumber;DeepValidator.isNumeric=validator.isNumeric;DeepValidator.isPartialEqual=_.isMatch;DeepValidator.isString=_.isString;DeepValidator.isSubstring=validator.contains;DeepValidator.isSurrogatePair=validator.isSurrogatePair;DeepValidator.isURL=validator.isURL;DeepValidator.isUUID=validator.isUUID;DeepValidator.isUppercase=validator.isUppercase;DeepValidator.isVariableWidth=validator.isVariableWidth;DeepValidator.isWhitelisted=validator.isWhitelisted;DeepValidator.ltrim=validator.ltrim;DeepValidator.normalizeEmail=validator.normalizeEmail;DeepValidator.rtrim=validator.rtrim;DeepValidator.stripLow=validator.stripLow;DeepValidator.toArray=_.toArray;DeepValidator.toBoolean=validator.toBoolean;DeepValidator.toDate=validator.toDate;DeepValidator.toFinite=_.toFinite;DeepValidator.trim=validator.trim;DeepValidator.unescape=validator.unescape;DeepValidator.whitelist=validator.whitelist;return DeepValidator}();exports.DeepValidator=DeepValidator;_.each(DeepValidator,function(v,k){if(DeepValidator.hasOwnProperty(k)&&_.isFunction(v)&&k.substr(0,2)==="is"){DeepValidator[k+"OrNull"]=function(value){return value===null||DeepValidator[k].apply(DeepValidator,arguments)}}});var DeepValidatorMerged=function(_super){__extends(DeepValidatorMerged,_super);function DeepValidatorMerged(){_super.apply(this,arguments)}return DeepValidatorMerged}(DeepValidator);exports.DeepValidatorMerged=DeepValidatorMerged;var Validator=function(_super){__extends(Validator,_super);function Validator(){_super.apply(this,arguments)}return Validator}(DeepValidator);exports.Validator=Validator;var ValidatorMerged=function(_super){__extends(ValidatorMerged,_super);function ValidatorMerged(){_super.apply(this,arguments)}return ValidatorMerged}(DeepValidatorMerged);exports.ValidatorMerged=ValidatorMerged;exports.deepValidator=function(schema,rootFlow){return new DeepValidator(schema,rootFlow)};exports.deepValidatorMerged=function(schema,rootFlow){return new DeepValidatorMerged(schema,rootFlow)};